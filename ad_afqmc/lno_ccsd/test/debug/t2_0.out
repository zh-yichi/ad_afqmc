#INFO: **** input file is /home/yichi/research/software/cs_afqmc/ad_afqmc/lno_ccsd/test/debug/t2_0.py ****
from pyscf import gto, scf, cc
from ad_afqmc.lno_ccsd import lno_ccsd, lno_maker
import os
# import numpy as np

# T shape H2 dimer
# d = 3
# atoms = f'''
# H     0.000     0.000    -0.370
# H     0.000     0.000     0.370
# H     {d}       0.000     0.000
# H     {0.74+d}  0.000     0.000
# '''

a = 1. # 2aB
nH = 6
atoms = ""
for i in range(nH):
    atoms += f"H {i*a:.5f} 0.00000 0.00000 \n"

mol = gto.M(atom=atoms, basis="sto6g", verbose=4)
mf = scf.RHF(mol)
mf.kernel()

mycc = cc.CCSD(mf)
mycc.kernel()

options = {'n_eql': 5,
           'n_prop_steps': 30,
            'n_ene_blocks': 1,
            'n_sr_blocks': 10,
            'n_blocks': 5,
            'n_walkers': 1,
            'seed': 98,
            'walker_type': 'rhf',
            'trial': 'cisd',
            'dt':0.005,
            'ad_mode':None,
            'use_gpu': False,
            }

# u = lno_maker.thouless_trans(mycc.t1)
# mo_t = mf.mo_coeff @ u
# mf.mo_coeff = mo_t

import numpy as np
t2 = mycc.t2
t2_0 = np.zeros(t2.shape)
mycc.t2 = t2_0
from ad_afqmc import pyscf_interface, run_afqmc
pyscf_interface.prep_afqmc(mycc,chol_cut=1e-7)

from mpi4py import MPI
MPI.Finalize()
run_afqmc.run_afqmc(options=options, nproc=5)#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='yichi-thinkpad', release='4.4.0-26100-Microsoft', version='#5074-Microsoft Fri Jan 01 08:00:00 PST 2016', machine='x86_64')  Threads 12
Python 3.10.16 | packaged by conda-forge | (main, Dec  5 2024, 14:16:10) [GCC 13.3.0]
numpy 1.24.3  scipy 1.14.1  h5py 3.12.1
Date: Tue Sep 23 17:07:47 2025
PySCF version 2.8.0
PySCF path  /home/yichi/research/software/lno_pyscf
GIT HEAD (branch master) ef75f4190e4de208685670651dc6c467f72b6794

[ENV] PYSCF_EXT_PATH /home/yichi/research/software/pyscf
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 6
[INPUT] num. electrons = 6
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 H      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 H      1.000000000000   0.000000000000   0.000000000000 AA    1.889726124565   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  3 H      2.000000000000   0.000000000000   0.000000000000 AA    3.779452249130   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  4 H      3.000000000000   0.000000000000   0.000000000000 AA    5.669178373695   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  5 H      4.000000000000   0.000000000000   0.000000000000 AA    7.558904498260   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  6 H      5.000000000000   0.000000000000   0.000000000000 AA    9.448630622825   0.000000000000   0.000000000000 Bohr   0.0

nuclear repulsion = 4.603841735004
number of shells = 6
number of NR pGTOs = 36
number of NR cGTOs = 6
basis = sto6g
ecp = {}
CPU time:         1.19


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tmp/tmpl9r8md67
max_memory 4000 MB (current use 136 MB)
Set gradient conv threshold to 3.16228e-05
Initial guess from minao.
init E= -2.43456844968186
  HOMO = -0.206186844053804  LUMO = 0.134147801579113
cycle= 1 E= -3.1487806963508  delta_E= -0.714  |g|= 0.0984  |ddm|= 1.71
  HOMO = -0.322364050884791  LUMO = 0.205265687081062
cycle= 2 E= -3.15516555755206  delta_E= -0.00638  |g|= 0.0314  |ddm|= 0.222
  HOMO = -0.32657231270121  LUMO = 0.219132025413817
cycle= 3 E= -3.15597595168783  delta_E= -0.00081  |g|= 0.00575  |ddm|= 0.0797
  HOMO = -0.329504962281801  LUMO = 0.219324890545479
cycle= 4 E= -3.15600091849169  delta_E= -2.5e-05  |g|= 0.000147  |ddm|= 0.018
  HOMO = -0.329429609111351  LUMO = 0.219283193175082
cycle= 5 E= -3.15600092949307  delta_E= -1.1e-08  |g|= 8.09e-06  |ddm|= 0.000293
  HOMO = -0.329440909371494  LUMO = 0.21928831661454
cycle= 6 E= -3.1560009295473  delta_E= -5.42e-11  |g|= 1.06e-07  |ddm|= 2.49e-05
  HOMO = -0.329441053062924  LUMO = 0.219288365072638
Extra cycle  E= -3.15600092954731  delta_E= -9.77e-15  |g|= 3.42e-08  |ddm|= 1.93e-07
converged SCF energy = -3.15600092954731

******** <class 'pyscf.cc.ccsd.CCSD'> ********
CC2 = 0
CCSD nocc = 3, nmo = 6
max_cycle = 50
direct = 0
conv_tol = 1e-07
conv_tol_normt = 1e-05
diis_space = 6
diis_start_cycle = 0
diis_start_energy_diff = 1e+09
max_memory 4000 MB (current use 142 MB)
Init t2, MP2 energy = -3.21911395512482  E_corr(MP2) -0.0631130255775121
Init E_corr(CCSD) = -0.0631130255775127
cycle = 1  E_corr(CCSD) = -0.0845186863080102  dE = -0.0214056607  norm(t1,t2) = 0.0635371
cycle = 2  E_corr(CCSD) = -0.093478483708098  dE = -0.0089597974  norm(t1,t2) = 0.0329352
cycle = 3  E_corr(CCSD) = -0.101050325428887  dE = -0.00757184172  norm(t1,t2) = 0.0171821
cycle = 4  E_corr(CCSD) = -0.101343622036368  dE = -0.000293296607  norm(t1,t2) = 0.00397072
cycle = 5  E_corr(CCSD) = -0.101172438387178  dE = 0.000171183649  norm(t1,t2) = 0.00161877
cycle = 6  E_corr(CCSD) = -0.101226441797361  dE = -5.40034102e-05  norm(t1,t2) = 0.000300468
cycle = 7  E_corr(CCSD) = -0.101212334727656  dE = 1.41070697e-05  norm(t1,t2) = 9.39978e-05
cycle = 8  E_corr(CCSD) = -0.101212433529271  dE = -9.88016152e-08  norm(t1,t2) = 2.26032e-05
cycle = 9  E_corr(CCSD) = -0.101213141225318  dE = -7.07696047e-07  norm(t1,t2) = 4.33698e-06
cycle = 10  E_corr(CCSD) = -0.101213574853364  dE = -4.33628046e-07  norm(t1,t2) = 1.43854e-06
cycle = 11  E_corr(CCSD) = -0.101213601201206  dE = -2.63478423e-08  norm(t1,t2) = 1.75363e-07
CCSD converged
E(CCSD) = -3.257214530748514  E_corr = -0.101213601201206
#
# Preparing AFQMC calculation
# If you import pyscf cc modules and use MPI for AFQMC in the same script, finalize MPI before calling the AFQMC driver.
# Calculating Cholesky integrals
# Finished calculating Cholesky integrals
#
# Size of the correlation space:
# Number of electrons: (3, 3)
# Number of basis functions: 6
# Number of Cholesky vectors: 15
#
# Hostname: yichi-thinkpad
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Number of MPI ranks: 5
#
# norb: 6
# nelec: (3, 3)
#
# n_eql: 5
# n_prop_steps: 30
# n_ene_blocks: 1
# n_sr_blocks: 10
# n_blocks: 5
# n_walkers: 1
# seed: 98
# walker_type: rhf
# trial: cisd
# dt: 0.005
# use_gpu: False
# n_exp_terms: 6
# orbital_rotation: True
# do_sr: True
# symmetry: False
# save_walkers: False
# ene0: 0.0
# free_projection: False
# n_batch: 1
# LNO: False
# orbE: 0
# maxError: 0.001
#
# Equilibration sweeps:
#   Iter        Block energy      Walltime
#     0      -3.156007484e+00     3.40e+00 
#     1      -3.248546839e+00     1.34e+01 
#     2      -3.237497568e+00     2.22e+01 
#     3      -3.236656427e+00     2.24e+01 
#     4      -3.246036291e+00     2.27e+01 
#     5      -3.256985664e+00     2.29e+01 
#
# Sampling sweeps:
#  Iter        Mean energy          Stochastic error       Walltime
     0      -3.280116510e+00        5.399838862e-02        3.06e+01 
     1      -3.259029642e+00        2.838429788e-02        3.06e+01 
     2      -3.260445125e+00        1.924076309e-02        3.06e+01 
     3      -3.261996309e+00        1.531766352e-02        3.07e+01 
     4      -3.272519770e+00        1.657069590e-02        3.07e+01 
#
# Number of large deviations: 0
# Number of outliers in post: 0 
#
# Mean: -3.27251977e+00
# Block size    # of blocks         Mean                Error
      1               25       -3.27251977e+00       1.657070e-02
      2               12       -3.26387091e+00       9.642367e-03
      3                8       -3.26387091e+00       1.202517e-02
      5                5       -3.27251977e+00       1.400930e-02
     10                2       -3.26199631e+00       4.193279e-03
# Stocahstic error estimate: 1.657070e-02
#
AFQMC energy: -3.27 +/- 0.02

ph_afqmc walltime: 30.879714250564575
