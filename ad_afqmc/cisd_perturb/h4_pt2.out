#INFO: **** input file is /home/yichi/research/software/cs_afqmc/ad_afqmc/cisd_perturb/test.py ****
from pyscf import gto, scf, cc
import numpy as np
from jax import numpy as jnp
from jax import vmap

a = 1.5 # 2aB
nH = 4
atoms = ""
for i in range(nH):
    atoms += f"H {i*a:.5f} 0.00000 0.00000 \n"

mol = gto.M(atom=atoms, basis="sto6g", verbose=4)
mol.build()

mf = scf.RHF(mol)#.density_fit()
e = mf.kernel()

mycc = cc.CCSD(mf)
e = mycc.kernel()

options = {'n_eql': 4,
           'n_prop_steps': 10,
            'n_ene_blocks': 1,
            'n_sr_blocks': 10,
            'n_blocks': 10,
            'n_walkers': 2,
            'seed': 2,
            'walker_type': 'rhf',
            'trial': 'cisd',
            'dt':0.005,
            'free_projection':False,
            'ad_mode':None,
            'use_gpu': False,
            }

from ad_afqmc import pyscf_interface, mpi_jax, wavefunctions
from ad_afqmc.cisd_perturb import sample_pt
pyscf_interface.prep_afqmc(mycc,chol_cut=1e-7)

sample_pt.run_afqmc_cisd_pt(options,nproc=5)
#INFO: ******************** input file end ********************


System: uname_result(system='Linux', node='yichi-thinkpad', release='4.4.0-26100-Microsoft', version='#5074-Microsoft Fri Jan 01 08:00:00 PST 2016', machine='x86_64')  Threads 12
Python 3.10.16 | packaged by conda-forge | (main, Dec  5 2024, 14:16:10) [GCC 13.3.0]
numpy 1.24.3  scipy 1.14.1  h5py 3.12.1
Date: Mon Oct  6 13:36:39 2025
PySCF version 2.8.0
PySCF path  /home/yichi/research/software/lno_pyscf
GIT HEAD (branch master) ef75f4190e4de208685670651dc6c467f72b6794

[ENV] PYSCF_EXT_PATH /home/yichi/research/software/pyscf
[CONFIG] conf_file None
[INPUT] verbose = 4
[INPUT] num. atoms = 4
[INPUT] num. electrons = 4
[INPUT] charge = 0
[INPUT] spin (= nelec alpha-beta = 2S) = 0
[INPUT] symmetry False subgroup None
[INPUT] Mole.unit = angstrom
[INPUT] Symbol           X                Y                Z      unit          X                Y                Z       unit  Magmom
[INPUT]  1 H      0.000000000000   0.000000000000   0.000000000000 AA    0.000000000000   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  2 H      1.500000000000   0.000000000000   0.000000000000 AA    2.834589186848   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  3 H      3.000000000000   0.000000000000   0.000000000000 AA    5.669178373695   0.000000000000   0.000000000000 Bohr   0.0
[INPUT]  4 H      4.500000000000   0.000000000000   0.000000000000 AA    8.503767560543   0.000000000000   0.000000000000 Bohr   0.0

nuclear repulsion = 1.52873416488
number of shells = 4
number of NR pGTOs = 24
number of NR cGTOs = 4
basis = sto6g
ecp = {}
CPU time:         1.11


******** <class 'pyscf.scf.hf.RHF'> ********
method = RHF
initial guess = minao
damping factor = 0
level_shift factor = 0
DIIS = <class 'pyscf.scf.diis.CDIIS'>
diis_start_cycle = 1
diis_space = 8
diis_damp = 0
SCF conv_tol = 1e-09
SCF conv_tol_grad = None
SCF max_cycles = 50
direct_scf = True
direct_scf_tol = 1e-13
chkfile to save SCF result = /tmp/tmpcjp3d0bu
max_memory 4000 MB (current use 131 MB)
Set gradient conv threshold to 3.16228e-05
Initial guess from minao.
init E= -1.25400672440918
  HOMO = -0.196338381874407  LUMO = 0.0263432378732702
cycle= 1 E= -1.84005933507816  delta_E= -0.586  |g|= 0.0596  |ddm|= 1.47
  HOMO = -0.294732568227935  LUMO = 0.119787799138635
cycle= 2 E= -1.84405278465786  delta_E= -0.00399  |g|= 0.0232  |ddm|= 0.152
  HOMO = -0.301834854077848  LUMO = 0.12860786111182
cycle= 3 E= -1.84478113606802  delta_E= -0.000728  |g|= 0.00323  |ddm|= 0.0881
  HOMO = -0.302366976245764  LUMO = 0.128585220859671
cycle= 4 E= -1.84478848460262  delta_E= -7.35e-06  |g|= 6.15e-05  |ddm|= 0.0084
  HOMO = -0.302312231994017  LUMO = 0.128550751350287
cycle= 5 E= -1.8447884877262  delta_E= -3.12e-09  |g|= 3.38e-05  |ddm|= 0.000107
  HOMO = -0.302291442449674  LUMO = 0.128537674861949
cycle= 6 E= -1.84478848843588  delta_E= -7.1e-10  |g|= 2.32e-05  |ddm|= 4.06e-05
  HOMO = -0.302247762890425  LUMO = 0.128512044950956
Extra cycle  E= -1.84478848898008  delta_E= -5.44e-10  |g|= 8.39e-06  |ddm|= 5.98e-05
converged SCF energy = -1.84478848898008

******** <class 'pyscf.cc.ccsd.CCSD'> ********
CC2 = 0
CCSD nocc = 2, nmo = 4
max_cycle = 50
direct = 0
conv_tol = 1e-07
conv_tol_normt = 1e-05
diis_space = 6
diis_start_cycle = 0
diis_start_energy_diff = 1e+09
max_memory 4000 MB (current use 136 MB)
Init t2, MP2 energy = -1.93160951605396  E_corr(MP2) -0.0868210270738816
Init E_corr(CCSD) = -0.0868210271344146
cycle = 1  E_corr(CCSD) = -0.128511946673767  dE = -0.0416909195  norm(t1,t2) = 0.125477
cycle = 2  E_corr(CCSD) = -0.148949110154808  dE = -0.0204371635  norm(t1,t2) = 0.0661739
cycle = 3  E_corr(CCSD) = -0.166223180421201  dE = -0.0172740703  norm(t1,t2) = 0.033412
cycle = 4  E_corr(CCSD) = -0.168229076118528  dE = -0.0020058957  norm(t1,t2) = 0.0122444
cycle = 5  E_corr(CCSD) = -0.168732983448652  dE = -0.00050390733  norm(t1,t2) = 0.00861462
cycle = 6  E_corr(CCSD) = -0.169998861520842  dE = -0.00126587807  norm(t1,t2) = 0.00293897
cycle = 7  E_corr(CCSD) = -0.169191884596481  dE = 0.000806976924  norm(t1,t2) = 0.00123143
cycle = 8  E_corr(CCSD) = -0.169388985742464  dE = -0.000197101146  norm(t1,t2) = 0.000453042
cycle = 9  E_corr(CCSD) = -0.169389242324438  dE = -2.56581975e-07  norm(t1,t2) = 3.65926e-06
cycle = 10  E_corr(CCSD) = -0.169389327076246  dE = -8.47518074e-08  norm(t1,t2) = 7.86029e-07
CCSD converged
E(CCSD) = -2.014177816056327  E_corr = -0.1693893270762457
# Hostname: yichi-thinkpad
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
#
# Preparing AFQMC calculation
# If you import pyscf cc modules and use MPI for AFQMC in the same script, finalize MPI before calling the AFQMC driver.
# Calculating Cholesky integrals
# Finished calculating Cholesky integrals
#
# Size of the correlation space:
# Number of electrons: (2, 2)
# Number of basis functions: 4
# Number of Cholesky vectors: 9
#
# Hostname: yichi-thinkpad
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Number of MPI ranks: 5
#
# norb: 4
# nelec: (2, 2)
#
# n_eql: 4
# n_prop_steps: 10
# n_ene_blocks: 1
# n_sr_blocks: 10
# n_blocks: 10
# n_walkers: 2
# seed: 2
# walker_type: rhf
# trial: cisd
# dt: 0.005
# free_projection: False
# use_gpu: False
# n_exp_terms: 6
# orbital_rotation: True
# do_sr: True
# symmetry: False
# save_walkers: False
# n_batch: 1
# ene0: 0
# LNO: False
# orbE: 0
# maxError: 0.001
#
# Hostname: yichi-thinkpad
# System Type: Linux
# Machine Type: x86_64
# Processor: x86_64
# Equilibration sweeps:
#   Iter 	 energy_pt 	 energy_og 	 Walltime
#     0 	 -2.0141778 	 -2.0141778 	 4.64
#     1 	 -2.0159180 	 -2.0116127 	 15.65 
#     2 	 -2.0759642 	 -2.0066545 	 24.64 
#     3 	 -2.2503812 	 -2.0084784 	 24.66 
#     4 	 -3.0222037 	 -2.0105183 	 24.68 
#
# Sampling sweeps:
#  Iter 	 energy_pt 	 error 		 energy_og 	 error 	 Walltime
     0 	 	 -3.155096 	   None   	 -2.008919 	 0.003131  24.76
     1 	 	 -2.978060 	 0.625048 	 -2.006776 	 0.002059  33.26
     2 	 	 -2.788628 	 0.441580 	 -2.007312 	 0.003313  41.74
     3 	 	 -2.614929 	 0.312507 	 -2.011378 	 0.004687  41.76
     4 	 	 -2.490940 	 0.268089 	 -2.011190 	 0.003856  41.79
     5 	 	 -2.400044 	 0.219562 	 -2.010138 	 0.003160  41.82
     6 	 	 -2.327937 	 0.197695 	 -2.008961 	 0.003088  41.85
     7 	 	 -2.258925 	 0.174138 	 -2.008088 	 0.002886  41.88
     8 	 	 -2.186212 	 0.171043 	 -2.007215 	 0.002753  41.91
     9 	 	 -2.195788 	 0.149944 	 -2.006771 	 0.002486  41.94
# Number of outliers in post: 12 
#
# Mean: -2.06748251e+00
# Block size    # of blocks         Mean                Error
      1               38       -2.06748251e+00       1.202310e-02
      2               19       -2.06748251e+00       1.048677e-02
      3               12       -2.06879759e+00       1.264277e-02
      5                7       -2.07020907e+00       1.500921e-02
     10                3       -2.06810492e+00       3.063549e-02
     15                2       -2.06810492e+00       2.300236e-02
# Stocahstic error estimate: 1.202310e-02
#
#
# Mean: -2.01133586e+00
# Block size    # of blocks         Mean                Error
      1               38       -2.01133586e+00       2.035841e-03
      2               19       -2.01133586e+00       2.022388e-03
      3               12       -2.01167473e+00       2.034154e-03
      5                7       -2.01174289e+00       2.220499e-03
     10                3       -2.01197312e+00       3.439717e-03
     15                2       -2.01197312e+00       1.455049e-03
# Stocahstic error estimate: 2.035841e-03
#
Final Results:
AFQMC/CISD_PT energy: -2.067483 +/- 0.012023
AFQMC/CISD_OG energy: -2.011336 +/- 0.002036
total run time: 41.95
# running AFQMC on CPU
